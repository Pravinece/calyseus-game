# Colyseus Game Flow Explanation

## Room Creation Flow

### 1. Create Room API Hit
```
POST /api/create-room → Creates room record in database/memory
```
**This ONLY creates room metadata, NOT the game server**

### 2. Frontend Joins Game Room
```javascript
// Frontend connects to Colyseus
const room = await client.joinOrCreate('game_room', { username, roomId });
```
**This CREATES the actual Colyseus game server instance**

## What is sessionId?
- **sessionId** = Auto-generated by Colyseus server (NOT frontend)
- **Format**: Random string like "BxY2K9mQ" or "7Hj3Lp8N"
- **Each WebSocket connection gets unique sessionId**
- **Frontend CANNOT choose sessionId**

```javascript
// Frontend connects
const room = await client.joinOrCreate('game_room', { username });
console.log(room.sessionId); // "BxY2K9mQ" (auto-generated)
```

```
Room: "game_room_abc123"
├── Player 1: sessionId = "BxY2K9mQ" (auto-generated)
├── Player 2: sessionId = "7Hj3Lp8N" (auto-generated)
└── Player 3: sessionId = "Kp9Mx2Qw" (auto-generated)
```

## Game Server Creation
- **First player joins** → Creates new GameRoom instance
- **Second player joins** → Joins SAME GameRoom instance
- **One GameRoom handles multiple players**

```
Player 1 joins → GameRoom created
Player 2 joins → Joins existing GameRoom
Player 3 joins → Joins existing GameRoom
All players leave → GameRoom destroyed
```

## Movement Sharing Code Location

### Backend: GameRoom.js
```javascript
this.onMessage('update-player', (client, data) => {
  const player = this.state.players.get(client.sessionId);
  player.pos = data.pos; // Updates position
  // Colyseus automatically syncs to all clients
});
```

### Frontend: Send Movement
```javascript
room.send('update-player', { 
  pos: [x, y, z], 
  rot: [rx, ry, rz], 
  anim: 1 
});
```

## Schema Explanation

### GameState.js
```javascript
export class GameState extends Schema {
  constructor() {
    super();
    this.players = new MapSchema(); // Container for all players
  }
}
```

**What happens:**
- `MapSchema()` = Special map that syncs automatically
- When player data changes → All clients get updates instantly
- `type({ map: Player })` = Tells Colyseus this is a map of Player objects

### Click Flow Example

**Frontend clicks "Move Forward":**
1. Frontend: `room.send('update-player', {pos: [1,0,0]})`
2. Backend: GameRoom receives message → Updates player.pos
3. Colyseus: Automatically sends update to ALL other players
4. Other players: See your character move

## Complete Frontend Code

```javascript
import { Client } from 'colyseus.js';

class GameClient {
  async createAndJoinRoom(username) {
    this.client = new Client('ws://localhost:2567');
    
    // Join Colyseus room (creates game server if needed)
    this.room = await this.client.joinOrCreate('game_room', { username });
    
    // Listen for other players
    this.room.state.players.onAdd((player, sessionId) => {
      console.log('Player joined:', player.username);
      // Create 3D character in Three.js scene
    });
    
    // Listen for player updates
    this.room.state.players.onChange((player, sessionId) => {
      // Update 3D character position in Three.js
      updatePlayerPosition(sessionId, player.pos, player.rot);
    });
  }
  
  // Send movement to server
  movePlayer(position, rotation, animation) {
    this.room.send('update-player', {
      pos: position,
      rot: rotation, 
      anim: animation
    });
  }
}
```

## Key Points
- **API creates room metadata** 
- **Colyseus creates actual game server when first player joins**
- **sessionId = player connection ID (not room ID)**
- **Movement syncs automatically via Schema**